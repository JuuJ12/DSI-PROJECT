import datetime
from typing import List, Dict

class DiabetesApp:
    def __init__(self):
        # ... (c√≥digo anterior)
        self.registros_glicemia = []

    # ... (m√©todos anteriores)

    def menu_principal(self):
        while True:
            print("\n=== APP DIABETES ===")
            print("1. Agendamentos")
            print("2. Monte seu Prato")
            print("3. Registro de Glicemia")  # Nova op√ß√£o
            print("4. Sair")
            
            opcao = input("Escolha uma op√ß√£o: ")
            
            if opcao == '1':
                self.menu_agendamentos()
            elif opcao == '2':
                self.menu_monte_prato()
            elif opcao == '3':
                self.menu_glicemia()
            elif opcao == '4':
                break
            else:
                print("Op√ß√£o inv√°lida!")

    # --- NOVA FUNCIONALIDADE: REGISTRO DE GLICEMIA ---
    def menu_glicemia(self):
        while True:
            print("\nüìä REGISTRO DE GLICEMIA")
            print("1. Novo registro")
            print("2. Ver hist√≥rico")
            print("3. Estat√≠sticas")
            print("4. Voltar")
            
            opcao = input("Escolha: ")
            
            if opcao == '1':
                self.registrar_glicemia()
            elif opcao == '2':
                self.ver_historico_glicemia()
            elif opcao == '3':
                self.estatisticas_glicemia()
            elif opcao == '4':
                break
            else:
                print("Op√ß√£o inv√°lida!")

    def registrar_glicemia(self):
        print("\nüìù NOVO REGISTRO DE GLICEMIA")
        
        try:
            valor = float(input("Valor da glicemia (mg/dL): "))
            data_str = input("Data (DD/MM/AAAA) ou Enter para data atual: ")
            hora_str = input("Hora (HH:MM) ou Enter para hora atual: ")
            
            if data_str == "":
                data_hora = datetime.datetime.now()
            else:
                if hora_str == "":
                    hora_str = "00:00"
                data_hora = datetime.datetime.strptime(f"{data_str} {hora_str}", "%d/%m/%Y %H:%M")
            
            print("Tipo de medi√ß√£o:")
            print("1. Jejum")
            print("2. P√≥s-refei√ß√£o")
            print("3. Aleat√≥ria")
            tipo_opcao = input("Escolha o tipo (1-3): ")
            
            tipos = {
                '1': 'Jejum',
                '2': 'P√≥s-refei√ß√£o',
                '3': 'Aleat√≥ria'
            }
            tipo = tipos.get(tipo_opcao, 'Aleat√≥ria')
            
            observacoes = input("Observa√ß√µes (opcional): ")
            
            registro = {
                'data_hora': data_hora,
                'valor': valor,
                'tipo': tipo,
                'observacoes': observacoes
            }
            
            self.registros_glicemia.append(registro)
            self.registros_glicemia.sort(key=lambda x: x['data_hora'])
            
            # Feedback imediato baseado no tipo e valor
            self.feedback_glicemia(registro)
            print("‚úÖ Registro salvo com sucesso!")
            
        except ValueError as e:
            print(f"‚ùå Erro: {e}")

    def feedback_glicemia(self, registro):
        valor = registro['valor']
        tipo = registro['tipo']
        
        print("\nüí° Feedback:")
        if tipo == 'Jejum':
            if valor < 70:
                print("‚ö†Ô∏è  Hipoglicemia! Valor abaixo do recomendado para jejum.")
            elif valor >= 70 and valor <= 100:
                print("‚úÖ Valor dentro da meta para jejum (70-100 mg/dL).")
            else:
                print("‚ö†Ô∏è  Valor acima da meta para jejum (>100 mg/dL).")
        elif tipo == 'P√≥s-refei√ß√£o':
            if valor < 70:
                print("‚ö†Ô∏è  Hipoglicemia! Valor abaixo do recomendado.")
            elif valor >= 70 and valor <= 140:
                print("‚úÖ Valor dentro da meta para p√≥s-refei√ß√£o (70-140 mg/dL).")
            else:
                print("‚ö†Ô∏è  Valor acima da meta para p√≥s-refei√ß√£o (>140 mg/dL).")
        else:  # Aleat√≥ria
            if valor < 70:
                print("‚ö†Ô∏è  Hipoglicemia! Valor abaixo do recomendado.")
            elif valor >= 70 and valor <= 200:
                print("‚úÖ Valor dentro da faixa esperada para aleat√≥ria (70-200 mg/dL).")
            else:
                print("‚ö†Ô∏è  Valor alto para aleat√≥ria (>200 mg/dL).")

    def ver_historico_glicemia(self):
        if not self.registros_glicemia:
            print("Nenhum registro de glicemia encontrado.")
            return
            
        print("\nüìã HIST√ìRICO DE GLICEMIA:")
        for i, registro in enumerate(self.registros_glicemia, 1):
            data_formatada = registro['data_hora'].strftime("%d/%m/%Y √†s %H:%M")
            print(f"{i}. {data_formatada} - {registro['valor']} mg/dL")
            print(f"   Tipo: {registro['tipo']}")
            if registro['observacoes']:
                print(f"   Obs: {registro['observacoes']}")
            print("-" * 40)

    def estatisticas_glicemia(self):
        if not self.registros_glicemia:
            print("Nenhum registro de glicemia para calcular estat√≠sticas.")
            return
            
        valores = [r['valor'] for r in self.registros_glicemia]
        media = sum(valores) / len(valores)
        maximo = max(valores)
        minimo = min(valores)
        
        print("\nüìà ESTAT√çSTICAS DE GLICEMIA:")
        print(f"Total de registros: {len(valores)}")
        print(f"M√©dia: {media:.1f} mg/dL")
        print(f"M√°ximo: {maximo} mg/dL")
        print(f"M√≠nimo: {minimo} mg/dL")
        
        # Contagem por tipo
        tipos = {}
        for registro in self.registros_glicemia:
            tipo = registro['tipo']
            if tipo not in tipos:
                tipos[tipo] = 0
            tipos[tipo] += 1
        
        print("\nüìä Registros por tipo:")
        for tipo, count in tipos.items():
            print(f"   {tipo}: {count}")
