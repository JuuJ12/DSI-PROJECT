import json
import random
from datetime import datetime
from typing import List, Dict, Tuple

class EducacaoDiabetes:
    def __init__(self):
        self.conteudos = self.carregar_conteudos()
        self.quizzes = self.carregar_quizzes()
        self.progresso = {
            'artigos_lidos': [],
            'quizzes_completos': [],
            'pontuacao_total': 0,
            'nivel': 'Iniciante'
        }

    def carregar_conteudos(self) -> Dict:
        return {
            'artigos': [
                {
                    'id': 1,
                    'titulo': 'O que √© Diabetes?',
                    'categoria': 'B√°sico',
                    'conteudo': """
# O que √© Diabetes?

Diabetes √© uma condi√ß√£o cr√¥nica que afeta como seu corpo processa o a√ß√∫car no sangue (glicose).

## Tipos Principais:

### Diabetes Tipo 1
- Autoimune: o corpo ataca as c√©lulas produtoras de insulina
- Geralmente diagnosticado na inf√¢ncia/adolesc√™ncia
- Requer insulina diariamente

### Diabetes Tipo 2
- O corpo n√£o usa a insulina adequadamente (resist√™ncia √† insulina)
- Mais comum em adultos, mas crescente em crian√ßas
- Pode ser controlado com medica√ß√£o, dieta e exerc√≠cios

### Pr√©-diabetes
- N√≠veis de glicose acima do normal, mas n√£o diab√©ticos
- Chance de revers√£o com mudan√ßas no estilo de vida
""",
                    'tempo_leitura': 5,
                    'dificuldade': 'Iniciante'
                },
                {
                    'id': 2,
                    'titulo': 'Contagem de Carboidratos',
                    'categoria': 'Nutri√ß√£o',
                    'conteudo': """
# Contagem de Carboidratos

T√©cnica essencial para controle glic√™mico.

## Por que contar carboidratos?
- Carboidratos t√™m maior impacto na glicemia
- Permite ajuste preciso da insulina
- Maior flexibilidade alimentar

## Alimentos ricos em carboidratos:
- P√£es, massas, arroz
- Frutas e sucos
- Leite e iogurte
- Doces e a√ß√∫cares
- Leguminosas (feij√£o, lentilha)

## T√©cnicas:
- Leitura de r√≥tulos
- Uso de aplicativos e tabelas
- Estimativa visual
""",
                    'tempo_leitura': 7,
                    'dificuldade': 'Intermedi√°rio'
                },
                {
                    'id': 3,
                    'titulo': 'Hipoglicemia: Preven√ß√£o e Tratamento',
                    'categoria': 'Emerg√™ncias',
                    'conteudo': """
# Hipoglicemia (Baixa Glicemia)

## Sintomas:
- Tremores e suor frio
- Confus√£o mental
- Tontura e vis√£o turva
- Fome intensa
- Palpita√ß√µes

## Tratamento Imediato (Regra 15-15):
1. Consuma 15g de carboidrato r√°pido:
   - 1 copo de suco (150ml)
   - 1 colher de sopa de a√ß√∫car
   - 3 balas
   - 1 sach√™ de glicose

2. Aguarde 15 minutos
3. Verifique glicemia novamente
4. Repita se necess√°rio

## Preven√ß√£o:
- N√£o pular refei√ß√µes
- Ajustar medica√ß√£o com orienta√ß√£o
- Monitorar antes de exerc√≠cios
- Ter sempre carboidrato r√°pido dispon√≠vel
""",
                    'tempo_leitura': 6,
                    'dificuldade': 'Intermedi√°rio'
                }
            ],
            'videos': [
                {
                    'id': 1,
                    'titulo': 'Como Aplicar Insulina Corretamente',
                    'categoria': 'Medica√ß√£o',
                    'url': 'video_insulina.mp4',
                    'duracao': 8,
                    'dificuldade': 'Iniciante'
                },
                {
                    'id': 2,
                    'titulo': 'Exerc√≠cios para Controle Glic√™mico',
                    'categoria': 'Atividade F√≠sica',
                    'url': 'video_exercicios.mp4',
                    'duracao': 12,
                    'dificuldade': 'Intermedi√°rio'
                }
            ]
        }

    def carregar_quizzes(self) -> List[Dict]:
        return [
            {
                'id': 1,
                'titulo': 'Conhecimentos B√°sicos sobre Diabetes',
                'perguntas': [
                    {
                        'pergunta': 'Qual horm√¥nio √© respons√°vel por baixar a glicose no sangue?',
                        'opcoes': ['Glucagon', 'Insulina', 'Adrenalina', 'Cortisol'],
                        'resposta_correta': 1,
                        'explicacao': 'A insulina √© o horm√¥nio que permite que a glicose entre nas c√©lulas.'
                    },
                    {
                        'pergunta': 'Qual √© o valor normal de glicemia em jejum?',
                        'opcoes': ['70-99 mg/dL', '100-125 mg/dL', '126-150 mg/dL', 'Acima de 150 mg/dL'],
                        'resposta_correta': 0,
                        'explicacao': 'Valores entre 70-99 mg/dL s√£o considerados normais em jejum.'
                    },
                    {
                        'pergunta': 'O que caracteriza hipoglicemia?',
                        'opcoes': [
                            'Glicemia acima de 200 mg/dL',
                            'Glicemia abaixo de 70 mg/dL', 
                            'Glicemia entre 100-125 mg/dL',
                            'Glicemia sempre alta'
                        ],
                        'resposta_correta': 1,
                        'explicacao': 'Hipoglicemia √© quando a glicemia est√° abaixo de 70 mg/dL.'
                    }
                ],
                'dificuldade': 'Iniciante',
                'pontos_por_pergunta': 10
            },
            {
                'id': 2,
                'titulo': 'Nutri√ß√£o e Diabetes',
                'perguntas': [
                    {
                        'pergunta': 'Qual destes alimentos tem maior √≠ndice glic√™mico?',
                        'opcoes': ['Ma√ß√£', 'P√£o branco', 'Lentilha', 'Br√≥colis'],
                        'resposta_correta': 1,
                        'explicacao': 'P√£o branco tem alto √≠ndice glic√™mico, elevando rapidamente a glicemia.'
                    },
                    {
                        'pergunta': 'Quantos gramas de carboidrato tem em 1 fatia de p√£o integral?',
                        'opcoes': ['5g', '10g', '15g', '25g'],
                        'resposta_correta': 2,
                        'explicacao': 'Uma fatia de p√£o integral tem aproximadamente 15g de carboidratos.'
                    },
                    {
                        'pergunta': 'Qual √© a t√©cnica "15-15" usada para?',
                        'opcoes': [
                            'Controlar glicemia alta',
                            'Tratar hipoglicemia',
                            'Contar carboidratos',
                            'Aplicar insulina'
                        ],
                        'resposta_correta': 1,
                        'explicacao': 'A regra 15-15 √© usada para tratar hipoglicemia: 15g de carboidrato, esperar 15 minutos.'
                    }
                ],
                'dificuldade': 'Intermedi√°rio',
                'pontos_por_pergunta': 15
            }
        ]

    def menu_educacao(self):
        while True:
            print("\nüéì EDUCA√á√ÉO SOBRE DIABETES")
            print(f"üìä Progresso: {self.progresso['pontuacao_total']} pontos | N√≠vel: {self.progresso['nivel']}")
            print("1. Artigos Educativos")
            print("2. Quizzes Interativos")
            print("3. Meu Progresso")
            print("4. Voltar")
            
            opcao = input("Escolha: ")
            
            if opcao == '1':
                self.menu_artigos()
            elif opcao == '2':
                self.menu_quizzes()
            elif opcao == '3':
                self.ver_progresso()
            elif opcao == '4':
                break
            else:
                print("Op√ß√£o inv√°lida!")

    def menu_artigos(self):
        while True:
            print("\nüìö ARTIGOS EDUCATIVOS")
            print("Categorias dispon√≠veis:")
            
            categorias = set(artigo['categoria'] for artigo in self.conteudos['artigos'])
            for i, categoria in enumerate(categorias, 1):
                artigos_cat = [a for a in self.conteudos['artigos'] if a['categoria'] == categoria]
                lidos = sum(1 for a in artigos_cat if a['id'] in self.progresso['artigos_lidos'])
                print(f"{i}. {categoria} ({lidos}/{len(artigos_cat)} lidos)")
            
            print(f"{len(categorias) + 1}. Ver todos os artigos")
            print(f"{len(categorias) + 2}. Voltar")
            
            try:
                opcao = int(input("Escolha: "))
                categorias_list = list(categorias)
                
                if 1 <= opcao <= len(categorias):
                    categoria_escolhida = categorias_list[opcao - 1]
                    self.listar_artigos_por_categoria(categoria_escolhida)
                elif opcao == len(categorias) + 1:
                    self.listar_todos_artigos()
                elif opcao == len(categorias) + 2:
                    break
                else:
                    print("Op√ß√£o inv√°lida!")
            except ValueError:
                print("Digite um n√∫mero v√°lido!")

    def listar_artigos_por_categoria(self, categoria: str):
        artigos = [a for a in self.conteudos['artigos'] if a['categoria'] == categoria]
        self.mostrar_lista_artigos(artigos, f"Artigos de {categoria}")

    def listar_todos_artigos(self):
        self.mostrar_lista_artigos(self.conteudos['artigos'], "Todos os Artigos")

    def mostrar_lista_artigos(self, artigos: List[Dict], titulo: str):
        print(f"\nüìñ {titulo}")
        for i, artigo in enumerate(artigos, 1):
            status = "‚úÖ" if artigo['id'] in self.progresso['artigos_lidos'] else "üìñ"
            print(f"{i}. {status} {artigo['titulo']} ({artigo['tempo_leitura']}min) - {artigo['dificuldade']}")
        
        try:
            opcao = int(input("\nEscolha o artigo para ler (0 para voltar): "))
            if opcao == 0:
                return
            if 1 <= opcao <= len(artigos):
                self.ler_artigo(artigos[opcao - 1])
            else:
                print("Op√ß√£o inv√°lida!")
        except ValueError:
            print("Digite um n√∫mero v√°lido!")

    def ler_artigo(self, artigo: Dict):
        print(f"\n{'='*60}")
        print(f"üìö {artigo['titulo']}")
        print(f"üìÅ Categoria: {artigo['categoria']}")
        print(f"‚è±Ô∏è  Tempo de leitura: {artigo['tempo_leitura']}min")
        print(f"üéØ Dificuldade: {artigo['dificuldade']}")
        print(f"{'='*60}")
        
        print(artigo['conteudo'])
        
        input("\nPressione Enter para continuar...")
        
        # Marcar como lido se n√£o estava
        if artigo['id'] not in self.progresso['artigos_lidos']:
            self.progresso['artigos_lidos'].append(artigo['id'])
            pontos = 5 if artigo['dificuldade'] == 'Iniciante' else 10
            self.progresso['pontuacao_total'] += pontos
            print(f"üéâ Artigo marcado como lido! +{pontos} pontos")
            self.atualizar_nivel()

    def menu_quizzes(self):
        while True:
            print("\nüéØ QUIZZES INTERATIVOS")
            
            for i, quiz in enumerate(self.quizzes, 1):
                completado = quiz['id'] in self.progresso['quizzes_completos']
                status = "‚úÖ" if completado else "üéØ"
                print(f"{i}. {status} {quiz['titulo']} - {quiz['dificuldade']}")
            
            print(f"{len(self.quizzes) + 1}. Voltar")
            
            try:
                opcao = int(input("Escolha o quiz: "))
                if opcao == len(self.quizzes) + 1:
                    break
                if 1 <= opcao <= len(self.quizzes):
                    self.executar_quiz(self.quizzes[opcao - 1])
                else:
                    print("Op√ß√£o inv√°lida!")
            except ValueError:
                print("Digite um n√∫mero v√°lido!")

    def executar_quiz(self, quiz: Dict):
        print(f"\n{'='*60}")
        print(f"üéØ {quiz['titulo']}")
        print(f"üéØ Dificuldade: {quiz['dificuldade']}")
        print(f"üìù {len(quiz['perguntas'])} perguntas")
        print(f"{'='*60}")
        
        input("Pressione Enter para come√ßar...")
        
        pontuacao_quiz = 0
        respostas_corretas = 0
        
        for i, pergunta in enumerate(quiz['perguntas'], 1):
            print(f"\n‚ùì Pergunta {i}/{len(quiz['perguntas'])}:")
            print(f"   {pergunta['pergunta']}")
            
            for j, opcao in enumerate(pergunta['opcoes']):
                print(f"   {j + 1}. {opcao}")
            
            try:
                resposta = int(input("\nSua resposta (1-4): ")) - 1
                
                if resposta == pergunta['resposta_correta']:
                    print("‚úÖ CORRETO!")
                    print(f"üí° {pergunta['explicacao']}")
                    pontuacao_quiz += quiz['pontos_por_pergunta']
                    respostas_corretas += 1
                else:
                    print("‚ùå INCORRETO")
                    print(f"üí° Resposta correta: {pergunta['opcoes'][pergunta['resposta_correta']]}")
                    print(f"üí° {pergunta['explicacao']}")
                
                input("\nPressione Enter para continuar...")
                
            except ValueError:
                print("Resposta inv√°lida! Quest√£o pulada.")

        # Resultado do quiz
        print(f"\n{'='*60}")
        print("üìä RESULTADO DO QUIZ")
        print(f"üéØ Acertos: {respostas_corretas}/{len(quiz['perguntas']}")
        print(f"üèÜ Pontua√ß√£o: {pontuacao_quiz} pontos")
        
        percentual_acertos = (respostas_corretas / len(quiz['perguntas'])) * 100
        
        if percentual_acertos >= 80:
            print("üåü Excelente! Voc√™ dominou o conte√∫do!")
        elif percentual_acertos >= 60:
            print("üí™ Bom trabalho! Continue estudando!")
        else:
            print("üìö Revise o material e tente novamente!")
        
        # Salvar progresso se completou pela primeira vez
        if quiz['id'] not in self.progresso['quizzes_completos']:
            self.progresso['quizzes_completos'].append(quiz['id'])
            self.progresso['pontuacao_total'] += pontuacao_quiz
            self.atualizar_nivel()
            print(f"üéâ Quiz completado! +{pontuacao_quiz} pontos adicionados!")

    def atualizar_nivel(self):
        pontos = self.progresso['pontuacao_total']
        
        if pontos >= 200:
            self.progresso['nivel'] = "Expert"
        elif pontos >= 100:
            self.progresso['nivel'] = "Avan√ßado"
        elif pontos >= 50:
            self.progresso['nivel'] = "Intermedi√°rio"
        else:
            self.progresso['nivel'] = "Iniciante"

    def ver_progresso(self):
        print("\nüìä MEU PROGRESSO EDUCACIONAL")
        print(f"üèÜ Pontua√ß√£o Total: {self.progresso['pontuacao_total']} pontos")
        print(f"üéØ N√≠vel Atual: {self.progresso['nivel']}")
        
        print(f"\nüìö Artigos Lidos: {len(self.progresso['artigos_lidos'])}/{len(self.conteudos['artigos'])}")
        for artigo in self.conteudos['artigos']:
            status = "‚úÖ" if artigo['id'] in self.progresso['artigos_lidos'] else "‚ùå"
            print(f"   {status} {artigo['titulo']}")
        
        print(f"\nüéØ Quizzes Completos: {len(self.progresso['quizzes_completos'])}/{len(self.quizzes)}")
        for quiz in self.quizzes:
            status = "‚úÖ" if quiz['id'] in self.progresso['quizzes_completos'] else "‚ùå"
            print(f"   {status} {quiz['titulo']}")
        
        # Pr√≥ximos objetivos
        print(f"\nüéØ PR√ìXIMOS OBJETIVOS:")
        artigos_nao_lidos = [a for a in self.conteudos['artigos'] if a['id'] not in self.progresso['artigos_lidos']]
        if artigos_nao_lidos:
            print(f"   üìñ Ler artigo: {artigos_nao_lidos[0]['titulo']}")
        
        quizzes_nao_feitos = [q for q in self.quizzes if q['id'] not in self.progresso['quizzes_completos']]
        if quizzes_nao_feitos:
            print(f"   üéØ Completar quiz: {quizzes_nao_feitos[0]['titulo']}")
        
        # Meta para pr√≥ximo n√≠vel
        pontos_prox_nivel = {
            'Iniciante': 50,
            'Intermedi√°rio': 100,
            'Avan√ßado': 200,
            'Expert': None
        }
        
        nivel_atual = self.progresso['nivel']
        if nivel_atual != 'Expert':
            pontos_necessarios = pontos_prox_nivel[nivel_atual] - self.progresso['pontuacao_total']
            if pontos_necessarios > 0:
                print(f"   ‚¨ÜÔ∏è  Faltam {pontos_necessarios} pontos para o pr√≥ximo n√≠vel")

# Atualizar a classe principal para incluir educa√ß√£o
class DiabetesApp:
    def __init__(self):
        self.agendamentos = []
        self.alimentos_db = {}  # Manter c√≥digo anterior
        self.prato_atual = []
        self.monitoramento = MonitoramentoGlicemia()
        self.educacao = EducacaoDiabetes()  # Nova funcionalidade

    def menu_principal(self):
        while True:
            print("\n=== APP DIABETES ===")
            print("1. Agendamentos")
            print("2. Monte seu Prato") 
            print("3. Monitoramento de Glicemia")
            print("4. Educa√ß√£o sobre Diabetes")  # Nova op√ß√£o
            print("5. Sair")
            
            opcao = input("Escolha uma op√ß√£o: ")
            
            if opcao == '1':
                self.menu_agendamentos()
            elif opcao == '2':
                self.menu_monte_prato()
            elif opcao == '3':
                self.monitoramento.menu_monitoramento()
            elif opcao == '4':
                self.educacao.menu_educacao()
            elif opcao == '5':
                break
            else:
                print("Op√ß√£o inv√°lida!")
